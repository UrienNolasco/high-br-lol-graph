// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Match {
  matchId       String   @id
  gameCreation  BigInt
  gameDuration  Int
  gameMode      String
  queueId       Int
  gameVersion   String
  mapId         Int
  hasTimeline   Boolean  @default(true)

  teams         MatchTeam[]
  participants  MatchParticipant[]

  @@index([queueId])
  @@index([queueId, gameCreation(sort: Desc)])
  @@map("matches")
}

model MatchParticipant {
  matchId       String
  puuid         String
  match         Match    @relation(fields: [matchId], references: [matchId], onDelete: Cascade)

  summonerName  String
  championId    Int
  championName  String
  teamId        Int
  role          String
  lane          String
  win           Boolean

  // Estatísticas finais (Match V5)
  kills         Int
  deaths        Int
  assists       Int
  kda           Float
  goldEarned    Int
  totalDamage   Int
  damageTaken   Int
  visionScore   Int

  // Séries temporais (Timeline V5) - índice = minuto
  goldGraph     Int[]
  xpGraph       Int[]
  csGraph       Int[]
  damageGraph   Int[]

  // Heatmaps e posicionamento
  deathPositions  Json
  killPositions   Json
  wardPositions   Json
  pathingSample   Json

  // Comportamento detalhado
  skillOrder      String[]
  itemTimeline    Json

  // Dados brutos (JSONB)
  runes           Json
  challenges      Json
  pings           Json
  spells          Int[]

  @@id([matchId, puuid])
  @@index([puuid])
  @@index([championId])
  @@index([puuid, championId])
  @@index([puuid, role])
  @@map("match_participants")
}

model MatchTeam {
  id          Int     @id @default(autoincrement())
  matchId     String
  teamId      Int
  win         Boolean
  bans        Int[]
  objectivesTimeline Json

  match Match @relation(fields: [matchId], references: [matchId], onDelete: Cascade)
  @@map("match_teams")
}

model User {
  puuid          String   @id
  gameName       String
  tagLine        String
  region         String   @default("br1")
  profileIconId  Int?
  summonerLevel  Int?

  // Ranked stats (League-V4)
  summonerId     String?
  tier           String?  // IRON, BRONZE, SILVER, GOLD, PLATINUM, EMERALD, DIAMOND, MASTER, GRANDMASTER, CHALLENGER
  rank           String?  // I, II, III, IV (null for Master+)
  leaguePoints   Int?
  rankedWins     Int?
  rankedLosses   Int?

  lastUpdated    DateTime @default(now())
  createdAt      DateTime @default(now())

  @@unique([gameName, tagLine, region])
  @@index([gameName])
  @@index([tier])
  @@map("users")
}

model ChampionStats {
  id           Int      @id @default(autoincrement())
  championId   Int
  championName String
  patch        String
  queueId      Int

  // Estatísticas agregadas
  gamesPlayed  Int      @default(0)
  wins         Int      @default(0)
  losses       Int      @default(0)
  winRate      Float    @default(0)

  // Métricas médias
  kda          Float    @default(0)
  dpm          Float    @default(0)
  cspm         Float    @default(0)
  gpm          Float    @default(0)

  // Taxas
  banRate      Float    @default(0)
  pickRate     Float    @default(0)

  // Tier calculado
  tier         String   @default("C")
  rank         Int      @default(0)

  @@unique([championId, patch, queueId])
  @@index([patch, queueId])
  @@map("champion_stats")
}

model PlayerStats {
  id              Int       @id @default(autoincrement())
  puuid           String
  patch           String?
  queueId         Int       @default(420)

  gamesPlayed     Int       @default(0)
  wins            Int       @default(0)
  losses          Int       @default(0)
  winRate         Float     @default(0)

  avgKda          Float     @default(0)
  avgDpm          Float     @default(0)
  avgCspm         Float     @default(0)
  avgGpm          Float     @default(0)
  avgVisionScore  Float     @default(0)

  roleDistribution Json    @default("{}")
  topChampions    Json      @default("[]")

  lastUpdated     DateTime  @default(now())

  @@unique([puuid, patch, queueId])
  @@index([puuid])
  @@index([puuid, patch])
  @@map("player_stats")
}

model PlayerChampionStats {
  id              Int       @id @default(autoincrement())
  puuid           String
  championId      Int
  patch           String?
  queueId         Int       @default(420)

  gamesPlayed     Int       @default(0)
  wins            Int       @default(0)
  losses          Int       @default(0)
  winRate         Float     @default(0)

  avgKda          Float     @default(0)
  avgDpm          Float     @default(0)
  avgCspm         Float     @default(0)
  avgGpm          Float     @default(0)
  avgVisionScore  Float     @default(0)

  avgCsd15        Float     @default(0)
  avgGd15         Float     @default(0)
  avgXpd15        Float     @default(0)

  roleDistribution Json    @default("{}")

  lastPlayedAt    DateTime?

  @@unique([puuid, championId, patch, queueId])
  @@index([puuid])
  @@index([puuid, lastPlayedAt])
  @@index([championId])
  @@map("player_champion_stats")
}
